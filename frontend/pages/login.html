<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入 - 辯論平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../static/css/styles.css">
</head>
<body class="bg-gray-50">
    <div id="navbar"></div>

    <div class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">辯論平台</h1>
            <p class="text-center text-gray-600 mb-8">1v1 文字辯論競技場</p>

            <div class="space-y-4">
                <button onclick="loginWithLine()" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.771.039 1.076l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                    </svg>
                    <span>使用 Line 登入</span>
                </button>

                <div class="text-center text-sm text-gray-500">
                    <p>登入後即可參與辯論、投票與查看排行</p>
                </div>
            </div>

            <div class="mt-8 pt-8 border-t border-gray-200">
                <h2 class="text-lg font-semibold mb-4">平台特色</h2>
                <ul class="space-y-2 text-sm text-gray-600">
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2">✓</span>
                        <span>回合制 1v1 辯論，公平競技</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2">✓</span>
                        <span>Elo 評分系統，精準反映實力</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2">✓</span>
                        <span>加權投票制度，專業評審參與</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2">✓</span>
                        <span>多種勝利條件，即時獲勝判定</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script src="../static/js/api.js"></script>
    <script src="../static/js/utils.js"></script>
    <script>
        // 檢查 URL 是否有 token（從 Line 回調）
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            setToken(token);
            
            // 如果 URL 包含使用者資料，直接儲存
            const userId = urlParams.get('user_id');
            const nickname = urlParams.get('nickname');
            const avatar = urlParams.get('avatar');
            
            if (userId && nickname) {
                const user = {
                    user_id: parseInt(userId),
                    nickname: decodeURIComponent(nickname),
                    avatar: decodeURIComponent(avatar || ''),
                    rating: 1200, // 預設 rating
                    is_admin: false
                };
                setCurrentUser(user);
                showSuccess(`登入成功！歡迎 ${user.nickname}！`);
            } else {
                showSuccess('登入成功！');
            }
            
            // 清除 URL 參數並跳轉
            setTimeout(() => {
                window.history.replaceState({}, document.title, window.location.pathname);
                window.location.href = 'index.html';
            }, 1500);
        }

        // 如果已登入，重定向到首頁
        if (getToken()) {
            window.location.href = 'index.html';
        }

        async function loginWithLine() {
            try {
                showLoading();
                const response = await AuthAPI.getLoginUrl();
                window.location.href = response.auth_url;
            } catch (error) {
                hideLoading();
                showError('獲取登入連結失敗：' + error.message);
            }
        }

        initPage();
    </script>
</body>
</html>
